---
title: "Astroã§ã‚‚Gatsbyã®excerptãŒã—ãŸã„!"
createdAt: "2023-05-17"
emoji: "ğŸ”§"
tags: ["tech"]
---

## ã¯ã˜ã‚ã«

`Gatsby`ã§ãƒ–ãƒ­ã‚°ã‚’æ§‹ç¯‰ã™ã‚‹å ´åˆ`gatsby-plugin-mdx`ã®ã‚ˆã†ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ã ã¨æ€ã„ã¾ã™ã€‚
ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã¯`excerpt`ã¨ã„ã†ç§ãŒã¨ã¦ã‚‚ä¾¿åˆ©ã«æ€ã£ã¦ã„ãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã£ãŸã®ã§ã™ãŒã€`Astro`ã«ä¹—ã‚Šæ›ãˆãŸéš›ã«ä½¿ãˆãªããªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚
ã“ã®è¨˜äº‹ã¯`Astro`ã§`excerpt`ã£ã½ã„ã‚‚ã®ã‚’å†ç¾ã—ãŸè¨˜éŒ²ã§ã™ã€‚

- `gatsby-plugin-mdx`  
<https://www.gatsbyjs.com/plugins/gatsby-plugin-mdx/#graphql-mdx-node-structure>

## å†ç¾ã—ãŸã„ã“ã¨

`excerpt`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯`mdx`ã‹ã‚‰å…ˆé ­ã®ä½•æ–‡å­—ã‹ã‚’æŠœãå‡ºã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ä¸‹ã®ã‚ˆã†ãªæ–‡ç« ã¯

```md
## ã¯ã˜ã‚ã«

å…ˆæ—¥ä»¥ä¸‹ã®è¨˜äº‹ã‚’èª­ã‚“ã§çœŸä¼¼ã—ãŸããªã£ãŸã®ã§ã€ç·´ç¿’ã‚‚å…¼ã­ã¦ Cloudflare Pages ã«ç§»è¡Œã—ã¾ã—ãŸã€‚

[æ—¥æœ¬å›½å†…ã ã¨ Netlify ã‚ˆã‚Š Cloudflare Pages ã®æ–¹ãŒé€Ÿã„ï¼](https://qiita.com/akitkat/items/dcbe4fcaacc051753e2b)

ã“ã‚Œã§å°‘ã—ã§ã‚‚æ—©ããªã£ã¦ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚

## ã‚„ã£ãŸã“ã¨

ä½œæ¥­ã®ã»ã¨ã‚“ã©ã‚’ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«è¡Œã„ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™!!

- [Cloudflare Pages ã§ Gatsby ã‚’å‹•ã‹ã™ã®ã¯æ¡ˆå¤–é›£ã—ã„](https://zenn.dev/appare45/articles/cloudflarepages-gatsby)
- [GitHub Actions ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ Cloudflare Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹](https://zenn.dev/nwtgck/articles/1fdee0e84e5808)

ãã®ã»ã‹ã®å‚è€ƒãƒªãƒ³ã‚¯ã¯[ã“ã®ã‚¤ã‚·ãƒ¥ãƒ¼](https://github.com/tunamaguro/blog/issues/26)ã«ã™ã¹ã¦è²¼ã£ã¦ã‚ã‚Šã¾ã™ã€‚

```

ã“ã®ã‚ˆã†ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚

```md
ã¯ã˜ã‚ã« å…ˆæ—¥ä»¥ä¸‹ã®è¨˜äº‹ã‚’èª­ã‚“ã§çœŸä¼¼ã—ãŸããªã£ãŸã®ã§ã€ç·´ç¿’ã‚‚å…¼ã­ã¦ Cloudflare Pages ã«ç§»è¡Œã—ã¾ã—ãŸã€‚ æ—¥æœ¬å›½å†…ã ã¨ Netlify ã‚ˆã‚Š Cloudflare Pages ã®æ–¹ãŒé€Ÿã„ï¼ ã“ã‚Œã§å°‘ã—ã§ã‚‚æ—©ããªã£ã¦ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚ ã‚„ã£ãŸã“ã¨ ä½œæ¥­ã®ã»ã¨ã‚“ã©ã‚’ä»¥ä¸‹ã®â€¦
```

ã“ã‚ŒãŒå¯èƒ½ã«ãªã‚‹ã¨é¢å€’ãªè¨˜äº‹ã®èª¬æ˜ã‚’è€ƒãˆã‚‹ä½œæ¥­ã‚’è‡ªå‹•ã§è¡Œã†ã‚ˆã†ã«ãªã‚Šã€è¨˜äº‹ã‚’å„æ‰‹é–“ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
(ã‚‚ã¡ã‚ã‚“è‡ªåˆ†ã§è€ƒãˆãŸèª¬æ˜ã®ã»ã†ãŒSEOä¸Šè‰¯ã„ã¨ã¯æ€ã„ã¾ã™ãŒé¢å€’ãªã®ã§ã™)
  
ğŸ‘‡`Gatsby`ã§`excerpt`ã‚’ä½¿ãˆã°è‡ªå‹•ã§descriptionã‚’è¨­å®šã§ãã‚‹!

```tsx

export const query = graphql`
  query ArticleQuery($id: String) {
    mdx(id: { eq: $id }) {
      frontmatter {
        title
        date(formatString: "yyyy-MM-DD")
        emoji
        tags
        slug
      }
      excerpt(pruneLength: 50)
    }
  }
`;

export const Head: HeadFC = ({ data }) => (
  <Seo
    title={data.mdx.frontmatter.title}
    desription={data.mdx.excerpt}
    pathname={`/articles/${data.mdx.frontmatter.slug}`}
  />
);
```

## è§£æ±ºç­–

å®Œå…¨ã«è¦‹é€ƒã—ã¦ã„ãŸã®ã§ã™ãŒã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ä¸Šã®è¦ä»¶ã‚’é”æˆã™ã‚‹æ–¹æ³•ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

<https://docs.astro.build/en/guides/markdown-content/#modifying-frontmatter-programmatically>

ã“ã‚Œã«ã‚ˆã‚‹ã¨`remark`ã‚ã‚‹ã„ã¯`rehype`ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æ›¸ãã“ã¨ã§`frontmatter`ã«å¥½ããªå€¤ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã§ã™ã€‚
ãã“ã§å„ç¨®ã®ç´ æ™´ã‚‰ã—ã„è§£èª¬ã‚’å‚è€ƒã«ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æ›¸ãã¾ã—ãŸã€‚

```typescript
import { toString } from "hast-util-to-string";
import { truncate, type Options } from "hast-util-truncate";

/** @type {import('unified').Plugin<[Options]>} */
export function rehypeExcerptContent(
  options: Options = { ellipsis: "â€¦" }
):
  | void
  | import("unified").Transformer<import("hast").Root, import("hast").Root> {
  return function (tree, { data }) {
    const truncatedTree = truncate(tree, { ellipsis: 'â€¦', ...options });
    const excerpt = toString(truncatedTree).replaceAll(/\s/g, " ");
    // @ts-ignore See https://docs.astro.build/en/guides/markdown-content/#modifying-frontmatter-programmatically
    data.astro.frontmatter.excerpt = excerpt;
  };
}

```

> ç§ã®ç†è§£ãŒä½ãä»•çµ„ã¿ãŒã‚ˆãã‚ã‹ã£ã¦ã„ãªã„ã®ã§ã€è©³ã—ãã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ãã®ä»–ã®è§£èª¬è¨˜äº‹ã‚’ã”è¦§ãã ã•ã„

ã“ã‚Œã‚’`astro.config.mjs`ã«è¨­å®šã—ã¾ã™ãŒã€ä»Šå›ã¯`md`ã§ã‚‚`mdx`ã§`excerpt`ã‚’ä½¿ã„ãŸã‹ã£ãŸã®ã§`markdown`ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚è©³ã—ãã¯ä¸Šè¨˜å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```javascript

import { rehypeExcerptContent } from "/path/to/plugin/rehypeExcerptPlugin";

// ç•¥

export default defineConfig({
  markdown: {
    remarkPlugins: [remarkMath],
    rehypePlugins: [rehypeKatex, rehypeExcerptContent],  //ğŸ‘ˆã“ã“
  },
```

ã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€`frontmatter.excerpt`ã«è¨˜äº‹ã®å…ˆé ­140æ–‡å­—ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚

## å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã‚‹

ç§ã¯è¨˜äº‹ã«`Content Collections`ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚`Aatro.props`ã‹ã‚‰`frontmatter`ã®å€¤ã‚’èª­ã¿å–ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ãŒã€`render`ã®è¿”ã‚Šå€¤ã®ä¸­ã®`remarkPluginFrontmatter`ã‹ã‚‰ãã®å€¤ã‚’èª­ã¿å–ã‚‹ã“ã¨å¯èƒ½ã§ã™ã€‚ç¢ºèªã—ã¦ã„ã¾ã›ã‚“ãŒã€`pages`ä»¥ä¸‹ã®å ´åˆã¯`Astro.props`ã§èª­ã¿å–ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

<https://docs.astro.build/en/guides/content-collections/#modifying-frontmatter-with-remark>

```tsx
const { Content, remarkPluginFrontmatter } = await article.render();
```

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚æ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€ã“ã®å€¤ã¯å‹å®‰å…¨ã§ã¯ãªã„ã®ã§ä¸‹ã®ã‚ˆã†ã«é©å½“ãªã‚¹ã‚­ãƒ¼ãƒã‚’æ›¸ã„ã¦å‹å®‰å…¨ã«ã—ã¦ã‹ã‚‰ä½¿ã„ã¾ã™ã€‚

```astro
---
// ç•¥
const frontmatterSchema = z.object({
  excerpt: z.string(),
});

const { Content, remarkPluginFrontmatter } = await article.render();
const frontmatter = frontmatterSchema.parse(remarkPluginFrontmatter);

const contentDescription = maybeDescription ?? frontmatter.excerpt;

---
<BaseLayout
  title={title}
  description={contentDescription}
// ç•¥
```

ç¢ºèªã—ã¦ã¿ã‚‹ã¨ç¢ºã‹ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

![](/images/astro-markdown-content-excerpt/meta.png)

## ãŠã‚ã‚Šã«

`Gatsby`ã£ã½ã„æ©Ÿèƒ½ã‚’å†ç¾ã™ã‚‹ã ã‘ã®è¨˜äº‹ã‚’æœ€å¾Œã¾ã§èª­ã‚“ã§ãã ã•ã‚Šã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚å°‘ã—ã§ã‚‚èª°ã‹ã®åŠ©ã‘ã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚


## ä½™è«‡

å®Ÿã¯ã“ã®è¨­å®šã‚’ã™ã‚‹å‰ã¯ã‚ˆã‚Šæ³¥è‡­ã„æ–¹æ³•ã§æ–‡ç« ã®æŠœç²‹ã‚’ä½œæˆã—ã¦ã„ã¾ã—ãŸãŒã€ã•ã™ãŒã«æ¥ãšã‹ã—ã„ã®ã§ãƒªãƒ³ã‚¯ã‚’è²¼ã‚‹ã ã‘ã«ã•ã›ã¦ãã ã•ã„ã€‚

https://github.com/tunamaguro/blog/commit/e0f8630791e531571c8f2d9312b6be089ccad5c3  
https://github.com/tunamaguro/blog/commit/e843bc7b043dc08c79cc936fe7fe1fe1de53d366